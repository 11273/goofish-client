# æ„å»º VitePress ç«™ç‚¹å¹¶å°†å…¶éƒ¨ç½²åˆ° GitHub Pages
#
name: Deploy VitePress site to Pages

on:
  # åœ¨é’ˆå¯¹ `main` åˆ†æ”¯çš„æ¨é€ä¸Šè¿è¡Œï¼Œåªæœ‰å½“ docs ç›¸å…³æ–‡ä»¶å˜æ›´æ—¶æ‰è§¦å‘
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/deploy.yml'

  # å…è®¸ä½ ä» Actions é€‰é¡¹å¡æ‰‹åŠ¨è¿è¡Œæ­¤å·¥ä½œæµç¨‹
  workflow_dispatch:

# è®¾ç½® GITHUB_TOKEN çš„æƒé™ï¼Œä»¥å…è®¸éƒ¨ç½²åˆ° GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# åªå…è®¸åŒæ—¶è¿›è¡Œä¸€æ¬¡éƒ¨ç½²ï¼Œè·³è¿‡æ­£åœ¨è¿è¡Œå’Œæœ€æ–°é˜Ÿåˆ—ä¹‹é—´çš„è¿è¡Œé˜Ÿåˆ—
# ä½†æ˜¯ï¼Œä¸è¦å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„è¿è¡Œï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›å…è®¸è¿™äº›ç”Ÿäº§éƒ¨ç½²å®Œæˆ
concurrency:
  group: pages
  cancel-in-progress: false

# ç¯å¢ƒå˜é‡
env:
  NODE_ENV: production
  CI: true

jobs:
  # æ„å»ºå·¥ä½œ
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # VitePress éœ€è¦è·å–æœ€åæ›´æ–°æ—¶é—´
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Install dependencies
        run: |
          # ä½¿ç”¨ npm ci ç¡®ä¿ç²¾ç¡®çš„ä¾èµ–å®‰è£…
          npm ci
          
      - name: Run type check
        run: npm run typecheck
        
      - name: Run linting
        run: npm run lint
        
      - name: Build with VitePress
        run: |
          echo "ğŸš€ å¼€å§‹æ„å»º VitePress ç«™ç‚¹..."
          npm run docs:build
          echo "âœ… æ„å»ºå®Œæˆ"
          
      - name: Verify build output
        run: |
          echo "ğŸ“Š æ„å»ºäº§ç‰©ä¿¡æ¯ï¼š"
          du -sh docs/.vitepress/dist
          ls -la docs/.vitepress/dist
          
      - name: Check build size
        run: |
          BUILD_SIZE=$(du -sh docs/.vitepress/dist | cut -f1)
          echo "ğŸ“¦ æ„å»ºå¤§å°: $BUILD_SIZE"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å¿…è¦çš„æ–‡ä»¶
          if [ ! -f "docs/.vitepress/dist/index.html" ]; then
            echo "âŒ ç¼ºå°‘ index.html æ–‡ä»¶"
            exit 1
          fi
          
          if [ ! -d "docs/.vitepress/dist/assets" ]; then
            echo "âš ï¸ è­¦å‘Š: ç¼ºå°‘ assets ç›®å½•"
          fi
          
          echo "âœ… æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡"
          
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/.vitepress/dist

  # éƒ¨ç½²å·¥ä½œ
  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: Deployment Success Notification
        if: success()
        run: |
          echo "ğŸ‰ ç½‘ç«™éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸ“„ ç½‘ç«™åœ°å€: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "â° éƒ¨ç½²æ—¶é—´: $(date)"
          
      - name: Deployment Failure Notification
        if: failure()
        run: |
          echo "âŒ ç½‘ç«™éƒ¨ç½²å¤±è´¥ï¼"
          echo "ğŸ” è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—å’Œé…ç½®"